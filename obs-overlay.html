<!DOCTYPE html>
<html>
	<head>
		<style>
			#msgWrapper {
				display: none;
				width: 800px;
				margin: auto;
				text-align: center;
				font-size: 24px;
				position: relative;
				top: 10px;
				font-family: impact;
				color: #fff;
				-webkit-text-stroke-width: 2px;
				-webkit-text-stroke-color: #000;
			}
			
			.author {
				color:green;
				display: block;
			}
			
			.message{
				color: #fff;
			}
		</style>
	</head>
	<body>
		<div id="msgWrapper"><span class="author"></span><span class="message"></span></div>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src='https://code.responsivevoice.org/responsivevoice.js'></script>
		<script src='assets/scripts/overlay.js'></script>
		<script>
		
			
			
			//window.onload = init;

			let isPlaying = false;
			
			function init(){
				responsiveVoice.setDefaultVoice("Hindi Female");
				let startTextToVoice = setInterval(function(){
					if(!isPlaying){
						getContent();
					}
				}, 20000);
				
			}
			
			let switcheroo = 1;
			function getContent(){
				let request = {
					method : "tags_api.get_active_votes",
					params: {
						"author":"foreveraverage", 
						"permlink":"aa4bd84f-6fab-11e8-8fb4-0242ac110002"
					},
					id: 1,
					jsonrpc: "2.0"
				}
				
				$.ajax({
					url: "https://api.steemit.com",
					type: "POST",
					data: JSON.stringify(request),
					datatype: "json",
					headers: {
						"Content-Type": "application/json"
					},
					success: function(response){
						console.log(response);
						switch(switcheroo){
							//get messages
							case 1: getContentReplies(response['result']['votes']); switcheroo = 2; break;
							//get upvotes
							case 2: getUpvotes(response['result']['votes']); switcheroo = 1; break;
						}
						 
					}
				})
			}
			
			let messageHistory = []
			let messages = [];
			function getContentReplies(votes){
				
				let request = {
					method : "tags_api.get_content_replies",
					params: {
						"author":"foreveraverage", 
						"permlink":"aa4bd84f-6fab-11e8-8fb4-0242ac110002"
					},
					id: 1,
					jsonrpc: "2.0"
				}
				
				
				
				$.ajax({
					url: "https://api.steemit.com",
					type: "POST",
					data: JSON.stringify(request),
					datatype: "json",
					headers: {
						"Content-Type": "application/json"
					},
					success: function(response){
						console.log(response);
						let x = 0;
						let author = undefined;
						let message = undefined;
						//loop through each comment
						for(let i = 0; i < response['result']['discussions'].length; i++){
							//get author name
							author = response['result']['discussions'][i]['author'];
							
							if(messageHistory[author] == undefined){
								messageHistory[author] = 0;
							}
							
							let authorMessageCounter = 0;
							for(let k = 0; k < votes.length; k++){
								if(votes[k]['voter'] === author){
									authorMessageCounter++;
									if(messageHistory[author]+1 == authorMessageCounter){
										let msg = response['result']['discussions'][i]['body'].substring(0, 260);;
										if(msg !== undefined){
											messageHistory[author]++;
											console.log( messageHistory[author] );
											message = msg;
											i = response['result']['discussions'].length;
										}
									}
								}
							}
						}
						
						if(message !== undefined){
							isPlaying = true;
							//select author box and append text
							let authorBox = document.querySelector(".author");
							authorBox.innerHTML = author;
							//select messagebox and append text
							let messageBox = document.querySelector(".message");
							messageBox.innerHTML = message;
							//fade in the msg box 
							
							$("#msgWrapper").fadeToggle("slow", function(){
								//play the message when fully visible
								responsiveVoice.speak(message, "Hindi Female", {onstart: function(){}, onend: function(){
									$("#msgWrapper").fadeToggle("slow");
									isPlaying = false;
								}});
							});
						}
					}
				})
			}
			
			let voteHistory = [];
			function getUpvotes(votes){
				console.log(votes);
				for(let i = 0; i < votes.length; i++){
					if(voteHistory[votes[i]['voter']] == undefined){
						isPlaying = true;
						console.log('test');
						let author = votes[i]['voter'];
						let percent =  votes[i]['percent'];
						percent = percent / 100;
						voteHistory[author] = percent/100;
						
						let authorBox = document.querySelector(".author");
						authorBox.innerHTML = author;
						//select messagebox and append text
						let imgNode = document.createElement('img');
						let messageBox = document.querySelector(".message");
						//append text
						let message = 'voted for '+percent+ ' percent';
						messageBox.innerHTML = message+'<br>';
						//append image
						imgNode.src = 'assets/images/vote.gif';
						imgNode.style.width = "450px";
						imgNode.style.height = "200px";
						messageBox.appendChild(imgNode);
						
						//fade in the msg box 
						
						$("#msgWrapper").fadeToggle("slow", function(){
							//play the message when fully visible
							responsiveVoice.speak(author + " " +message, "Hindi Female", {onstart: function(){}, onend: function(){
								let sound = new Audio('assets/audio/vote.mp3');
								sound.play();
								sound.addEventListener("ended", function(){
									$("#msgWrapper").delay(1000).fadeToggle("slow");
									isPlaying = false;
								})
							}});
						});
						i = votes.length;
					}
				}
			}
			
			// helping functions
			
			let overlay = new DLOverlay();
			overlay.initialize('foreveraverage', 'Hindi Female');
			overlay.start();
			
			/*let checkStatus = setInterval( function(){ 
				overlay.getContent( function(response){
				console.log(response);
					let votes = response.result.votes;
					switch(overlay.switcheroo){
						//get messages
						case 1: 
							overlay.getContentReplies(//response['result']['votes']
							 function(response){
								
								console.log( votes )
								let x = 0;
								let author = undefined;
								let message = undefined;
								//loop through each comment
								for(let i = 0; i < response['result']['discussions'].length; i++){
									//get author name
									author = response['result']['discussions'][i]['author'];
									
									if(messageHistory[author] == undefined){
										messageHistory[author] = 0;
									}
									
									let authorMessageCounter = 0;
									for(let k = 0; k < votes.length; k++){
										if(votes[k]['voter'] === author){
											authorMessageCounter++;
											if(messageHistory[author]+1 == authorMessageCounter){
												let msg = response['result']['discussions'][i]['body'].substring(0, 260);;
												if(msg !== undefined){
													messageHistory[author]++;
													console.log( messageHistory[author] );
													message = msg;
													i = response['result']['discussions'].length;
												}
											}
										}
									}
								}
								
								
								if(message !== undefined){
									isPlaying = true;
									overlay.speakAndShow(author, message, message, function(){}, function(){ isPlaying = false; });
								}
							})
							overlay.switcheroo = 2; break;
						//get upvotes
						case 2: for(let i = 0; i < votes.length; i++){
								if(voteHistory[votes[i]['voter']] == undefined){
									isPlaying = true;
									console.log('test');
									let author = votes[i]['voter'];
									let percent =  votes[i]['percent'];
									percent = percent / 100;
									voteHistory[author] = percent/100;
									
									let message = 'voted for '+percent+ ' percent';
									
									overlay.speakAndShow(author, message + '<br><img src="assets/images/vote.gif">', author + " " +message, function(){}, function(){ isPlaying = false; });
									i = votes.length;
								}
							}; 
							overlay.switcheroo = 1; break;
					}
				})}, 20000)*/
		</script>
	</body>
</html>